#!/bin/bash

# 定义全局变量
LOG_FILE="/var/log/network_config.log"

# 配置网络接口
function configure_network {
    log_message "开始配置网络接口"
    local interface_config=$(cat <<-EOF
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
    address 172.22.146.150
    gateway 172.22.146.1
    netmask 255.255.255.0

auto eth1
iface eth1 inet dhcp
EOF
)
    echo "$interface_config" | sudo tee /etc/network/interfaces > /dev/null
    sudo ifdown -a && sudo ifup -a
    log_message "网络接口配置完成"
}

# 发送激活请求
function send_activation_request {
    log_message "开始发送激活请求"
    local eth1_ip=$(get_eth1_ip)
    if [[ -z $eth1_ip ]]; then
        log_message "无法获取eth1的IP地址"
        return
    fi
    local activation_url="http://192.168.202.2/?ip=$eth1_ip"
    local response=$(curl -s -o /dev/null -w "%{http_code}" $activation_url)
    if [[ $response -eq 200 ]]; then
        log_message "激活请求成功"
    else
        log_message "激活请求失败，状态码: $response"
    fi
}

# 获取eth1的IP地址
function get_eth1_ip {
    ip -4 addr show eth1 | grep -oP '(?<=inet\s)\d+(\.\d+){3}'
}

# 配置路由规则
function configure_routing {
    log_message "开始配置路由规则"
    sudo ip route add 10.16.0.0/16 dev eth1
    sudo ip route add default via 172.22.146.1 dev eth0
    log_message "路由规则配置完成"
}

# 网络监控与路由切换
function monitor_network {
    log_message "开始监控网络"
    while true; do
        if ping -c 1 -W 1 8.8.8.8 &> /dev/null; then
            local current_route=$(get_current_default_route)
            if [[ $current_route!= "eth0" ]]; then
                log_message "eth0恢复，切换回eth0作为默认路由"
                switch_to_eth0
            fi
        else
            local current_route=$(get_current_default_route)
            if [[ $current_route!= "eth1" ]]; then
                log_message "eth0无法访问公网，切换到eth1作为默认路由"
                switch_to_eth1
            fi
        fi
        sleep 60
    done
}

# 获取当前默认路由
function get_current_default_route {
    ip route | grep 'default' | awk '{print $5}'
}

# 切换到eth0作为默认路由
function switch_to_eth0 {
    sudo ip route del default
    sudo ip route add default via 172.22.146.1 dev eth0
}

# 切换到eth1作为默认路由
function switch_to_eth1 {
    sudo ip route del default
    local eth1_gateway=$(ip route | grep 'eth1' | grep 'default' | awk '{print $3}')
    sudo ip route add default via $eth1_gateway dev eth1
}

# 记录日志
function log_message {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "$timestamp - $1" >> $LOG_FILE
}

# 主执行流程
function main {
    configure_network
    send_activation_request
    configure_routing
    monitor_network &
}

main
